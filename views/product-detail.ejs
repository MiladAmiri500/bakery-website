<!-- views/product-detail.ejs (updated wishlist to AJAX/guest) -->
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FreshCart â€” <%= product.name %>
    </title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <%- include('partials/sidebar') %>
        <%- include('partials/category-sidebar') %>
            <%- include('partials/header') %>

                <section class="section product-detail">
                    <div class="breadcrumbs">
                        <a href="/">Home</a> > <a href="/products?category=<%= product.category._id %>">
                            <%= product.category.name %>
                        </a> > <%= product.name %>
                    </div>

                    <div class="product-page-container">
                        <div class="product-gallery">
                            <div class="main-image-container">
                                <img src="<%= product.images[0] %>" alt="<%= product.name %> - Main View"
                                    id="main-product-image" class="main-image">
                            </div>
                            <div class="thumbnail-container">
                                <% product.images.forEach((image, index)=> { %>
                                    <img src="<%= image %>" alt="<%= product.name %> - View <%= index + 1 %>"
                                        class="thumbnail <%= index === 0 ? 'active' : '' %>" data-image="<%= image %>">
                                    <% }) %>
                            </div>
                        </div>

                        <div class="product-info">
                            <h1 class="product-title">
                                <%= product.name %>
                            </h1>

                            <div class="product-rating">
                                <div class="stars">
                                    <% for(let i=1; i <=5; i++) { %>
                                        <i
                                            class="fa<%= product.ratings >= i ? 's' : (product.ratings >= i - 0.5 ? 's fa-star-half-alt' : 'r') %> fa-star"></i>
                                        <% } %>
                                </div>
                                <a href="#reviews" class="rating-count">(<%= product.reviews.length %> Reviews)</a>
                            </div>

                            <p class="product-price">$<%= product.price.toFixed(2) %> / <%= product.unit %>
                            </p>

                            <p class="product-description">
                                <%= product.description || 'No description available.' %>
                            </p>

                            <div class="product-actions">
                                <form action="/cart/add/<%= product._id %>" method="POST" class="add-to-cart-form"
                                    data-product-id="<%= product._id %>">
                                    <% if (isInCart) { %>
                                        <button type="button" class="btn-add-cart added"
                                            onclick="location.href='/cart'">Added to Cart</button>
                                        <% } else { %>
                                            <div class="quantity-selector">
                                                <button type="button" class="quantity-btn qty-minus">-</button>
                                                <input type="text" id="quantity" name="quantity" value="1" readonly
                                                    class="qty-input">
                                                <button type="button" class="quantity-btn qty-plus">+</button>
                                            </div>
                                            <button type="submit" class="btn btn-primary"><i
                                                    class="fas fa-shopping-cart"></i> Add to Cart</button>
                                            <% } %>
                                </form>
                                <form action="/wishlist/add/<%= product._id %>" method="POST" class="wishlist-form">
                                    <button type="submit" class="btn btn-wishlist"><i
                                            class="fas fa-heart <%= isWishlisted ? 'filled' : '' %>"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="product-details-sections">
                        <div id="description" class="section-content">
                            <h3>Description</h3>
                            <p>
                                <%= product.description || 'No description available.' %>
                            </p>
                        </div>

                        <div id="features" class="section-content">
                            <h3>Features</h3>
                            <ul>
                                <% product.features.forEach(feature=> { %>
                                    <li>
                                        <%= feature %>
                                    </li>
                                    <% }) %>
                            </ul>
                        </div>

                        <div id="reviews" class="section-content">
                            <h3>Reviews (<%= product.reviews.length %>)</h3>
                            <% if (product.reviews.length===0) { %>
                                <p>No reviews yet.</p>
                                <% } else { %>
                                    <% product.reviews.forEach(review=> { %>
                                        <div class="review">
                                            <div class="review-header">
                                                <span class="review-author">
                                                    <%= review.user %>
                                                </span>
                                                <div class="stars">
                                                    <% for(let i=1; i <=5; i++) { %>
                                                        <i
                                                            class="fa<%= review.rating >= i ? 's' : (review.rating >= i - 0.5 ? 's fa-star-half-alt' : 'r') %> fa-star"></i>
                                                        <% } %>
                                                </div>
                                                <span class="review-date">
                                                    <%= new Date(review.date).toLocaleDateString() %>
                                                </span>
                                            </div>
                                            <p class="review-body">
                                                <%= review.comment %>
                                            </p>
                                        </div>
                                        <% }) %>
                                            <% } %>

                                                <div class="review-form">
                                                    <h3>Add Your Review</h3>
                                                    <form
                                                        action="<%= user ? '/product/' + product._id + '/review' : '/login' %>"
                                                        method="<%= user ? 'POST' : 'GET' %>">
                                                        <div class="form-group">
                                                            <label for="comment">Your Review</label>
                                                            <textarea id="comment" name="comment" class="form-control"
                                                                placeholder="Share your thoughts..."
                                                                required></textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="rating">Rating</label>
                                                            <select id="rating" name="rating" class="form-control"
                                                                required>
                                                                <option value="5">5 Stars - Excellent</option>
                                                                <option value="4">4 Stars - Good</option>
                                                                <option value="3">3 Stars - Average</option>
                                                                <option value="2">2 Stars - Fair</option>
                                                                <option value="1">1 Star - Poor</option>
                                                            </select>
                                                        </div>
                                                        <button type="submit" class="btn btn-submit">Submit
                                                            Review</button>
                                                    </form>
                                                </div>
                        </div>
                    </div>

                    <!-- Related Products Section (with side scrolling and View All) -->
                    <section class="related-products">
                        <h3>Related Products</h3>
                        <div class="related-container">
                            <div class="related-grid">
                                <% relatedProducts.forEach(product=> { %>
                                    <%- include('partials/product-card', { product, isWishlisted: isWishlisted,
                                        quantity: 1 }) %>
                                        <% }) %>
                            </div>
                            <a href="/products?category=<%= product.category._id %>"
                                class="btn btn-primary view-all-btn">View All</a>
                        </div>
                    </section>
                </section>

                <%- include('partials/footer') %>

                    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
                    <script src="/js/scripts.js"></script>
                    <script>
                        // AJAX for detail page add to cart
                        document.querySelector('.add-to-cart-form')?.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const form = e.target;
                            const productId = form.dataset.productId;
                            const quantityInput = form.querySelector('#quantity');
                            const quantity = parseFloat(quantityInput.value) || 1;

                            try {
                                const response = await fetch(`/cart/add/${productId}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: `quantity=${quantity}`
                                });
                                if (response.ok) {
                                    // Update UI to show 'Added to Cart'
                                    form.innerHTML = `<button type="button" class="btn-add-cart added" onclick="location.href='/cart'">Added to Cart</button>`;
                                }
                            } catch (err) {
                                console.error('Add to cart error:', err);
                            }
                        });

                        // Add "Go to Wishlist" link if already wishlisted on page load
                        const wishlistForm = document.querySelector('.wishlist-form');
                        if (wishlistForm) {
                            const button = wishlistForm.querySelector('.btn-wishlist');
                            const icon = button.querySelector('i');
                            if (icon && icon.classList.contains('filled')) {
                                button.insertAdjacentHTML('afterend', '<a href="/wishlist" class="go-to-wishlist">Go to Wishlist</a>');
                            }

                            // AJAX for detail page wishlist
                            wishlistForm.addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const button = e.target.querySelector('.btn-wishlist');
                                const icon = button.querySelector('i');
                                const productId = '<%= product._id %>';

                                // If already wishlisted (filled), navigate to wishlist instead of toggling
                                if (icon.classList.contains('filled')) {
                                    window.location.href = '/wishlist';
                                    return;
                                }

                                try {
                                    const response = await fetch(`/wishlist/add/${productId}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                        body: ''
                                    });
                                    console.log('Wishlist response status:', response.status);  // Debug: Check if 200
                                    if (response.ok) {
                                        let data;
                                        try {
                                            data = await response.json();
                                            console.log('Wishlist response data:', data);  // Debug: See exact JSON
                                        } catch (jsonErr) {
                                            console.error('JSON parse error:', jsonErr);  // Debug: If not JSON
                                            // Fallback: Assume added if no JSON but OK status
                                            data = { added: true };
                                        }
                                        // Update UI if added (or fallback)
                                        if (data.added) {
                                            icon.classList.add('filled');
                                            // Remove any existing link first (in case of re-clicks)
                                            const existingLink = button.nextElementSibling;
                                            if (existingLink && existingLink.classList.contains('go-to-wishlist')) {
                                                existingLink.remove();
                                            }
                                            // Add "Go to Wishlist" link on the right
                                            button.insertAdjacentHTML('afterend', '<a href="/wishlist" class="go-to-wishlist">Go to Wishlist</a>');
                                            console.log('UI updated: Icon filled and link added');  // Debug
                                        } else {
                                            console.log('No update: data.added was false/missing');  // Debug
                                        }
                                    } else {
                                        console.error('Response not OK:', response.status);  // Debug
                                    }
                                } catch (err) {
                                    console.error('Wishlist error:', err);
                                }
                            });
                        }
                    </script>
</body>

</html>